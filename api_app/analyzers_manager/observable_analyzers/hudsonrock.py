import logging

import requests

from api_app.analyzers_manager import classes
from api_app.analyzers_manager.exceptions import AnalyzerConfigurationException
from tests.mock_utils import MockUpResponse, if_mock_connections, patch

logger = logging.getLogger(__name__)


class HudsonRock(classes.ObservableAnalyzer):
    """
    This analyzer is a wrapper for hudson rock
    """

    compromised_since: str
    compromised_until: str
    _api_key_name: str

    url = "https://cavalier.hudsonrock.com/api/json/v2"

    def run(self):
        response = {}
        headers = {
            "api-key": self._api_key_name,
            "Content-Type": "application/json",
        }
        if self.observable_classification == self.ObservableTypes.IP:
            url = self.url + "/search-by-ip"
            response = requests.post(
                url, headers=headers, json={"ip": self.observable_name}
            )

        elif self.observable_classification == self.ObservableTypes.DOMAIN:
            url = (
                self.url
                + f"/search-by-domain?compromised_since={self.compromised_since}"
                + f"&compromised_until={self.compromised_until}"
            )
            response = requests.post(
                url, headers=headers, json={"domains": [self.observable_name]}
            )

        elif self.observable_classification == self.ObservableTypes.GENERIC:
            url = self.url + "/search-by-login"
            response = requests.post(
                url, headers=headers, json={"login": self.observable_name}
            )
        else:
            raise AnalyzerConfigurationException(
                f"Invalid observable type {self.observable_classification}"
                + f"{self.observable_name} for HudsonRock"
            )
        response.raise_for_status()
        return response.json()

    def update(self) -> bool:
        pass

    @classmethod
    def _monkeypatch(cls):
        patches = [
            if_mock_connections(
                patch(
                    "requests.get",
                    return_value=MockUpResponse(
                        [
                            {
                                "date_uploaded": "2019-11-07T04:38:32.024Z",
                                "stealer_family": "Vidar",
                                "antiviruses": "Not Found",
                                "employee_session_cookies": "null",
                                "date_compromised": "2019-11-04T13:33:47.000Z",
                                "credentials": [
                                    {
                                        "type": "client",
                                        "url": "••••••••••••••",
                                        "domain": "disney.com",
                                        "username": "•••••••",
                                        "password": "••••••••",
                                    }
                                ],
                                "stealer": "••••••••••••",
                                "employeeAt": ["••••••••••"],
                                "clientAt": [
                                    "•••••••••••••••",
                                    "•••••••••••",
                                    "••••••••••••",
                                    "•••••••••",
                                    "•••••••••••••",
                                    "••••••••••••••••••",
                                    "•••••••••",
                                    "•••••••••",
                                    "••••••••••",
                                    "•••••••••••",
                                    "••••••••••••",
                                    "••••••••••••••",
                                    "•••••••••",
                                    "•••••••••••••",
                                    "••••••••",
                                    "••••••••••••••••",
                                    "••••••••••",
                                    "••••••",
                                    "•••••••••••",
                                    "••••••••••••",
                                    "••••••••••••",
                                    "••••••••••",
                                    "•••••••••••",
                                    "••••••••••",
                                    "•••••••••••••",
                                    "••••••••••••••••",
                                    "••••••••••••",
                                    "•••••••••••",
                                    "••••••••••••••••",
                                    "•••••••••••••",
                                    "•••••••••",
                                    "••••••••••••",
                                    "••••••••",
                                    "••••••••••",
                                    "•••••••",
                                    "•••••••••••••",
                                    "••••••••••••••••",
                                    "•••••••••••••••••••",
                                    "••••••",
                                    "••••••••••",
                                    "••••••••••••••••••",
                                    "••••••••••••••••",
                                    "•••••••••",
                                    "•••••••••••",
                                    "••••••",
                                    "•••••••••",
                                    "•••••••••",
                                    "••••••••••",
                                    "•••••••••••••••",
                                ],
                                "ip": "••••••••••••••",
                                "malware_path": "••••••••••••••",
                            },
                            {
                                "date_uploaded": "2019-11-06T21:51:35.676Z",
                                "stealer_family": "Vidar",
                                "antiviruses": "Not Found",
                                "employee_session_cookies": "null",
                                "date_compromised": "2019-11-03T20:39:11.000Z",
                                "credentials": [
                                    {
                                        "type": "client",
                                        "url": "•••••••••••••••",
                                        "domain": "disney.com",
                                        "username": "•••",
                                        "password": "•••••••••",
                                    }
                                ],
                                "stealer": "••••••••••••••••••••••••••••••••",
                                "employeeAt": ["•••••••••••", "••••••••••", "••••••"],
                                "clientAt": [],
                                "ip": "•••••••••••••",
                                "malware_path": "•••••••••••••••••••",
                            },
                            {
                                "date_uploaded": "2021-07-11T12:17:51.429Z",
                                "stealer_family": "RedLine",
                                "computer_name": "This PC",
                                "operating_system": "Windows 10 Home x64",
                                "antiviruses": "Norton 360",
                                "employee_session_cookies": "null",
                                "date_compromised": "2021-07-06T23:27:32.000Z",
                                "credentials": [
                                    {
                                        "type": "client",
                                        "url": "••••••••",
                                        "domain": "disney.com",
                                        "username": "••••••",
                                        "password": "••••••••••",
                                    }
                                ],
                                "stealer": "•••••••••••••••••••",
                                "employeeAt": ["•••••••••", "••••••••", "••••••••••"],
                                "clientAt": [
                                    "•",
                                    "•",
                                    "••••",
                                    "••••••••••••••",
                                    "•••••••••",
                                    "••••••••••",
                                    "•••••••••••",
                                    "•••••••••",
                                    "••••••••••••",
                                    "•••••••••••••••••••",
                                    "••••••••••••••••",
                                    "•••••••••••••••••",
                                    "••••••••••••",
                                    "••••••••••",
                                    "••••••••••••••••••",
                                    "•••••••••••",
                                    "••••••••••••",
                                    "••••••••••••",
                                    "••••••••",
                                    "•••••••••••••••••",
                                    "••••••••••••••••",
                                    "••••••••••••••",
                                    "•••••••••••",
                                    "••••••••••••",
                                    "•••••••••••••••••",
                                    "•••••••••••••••••••••",
                                    "•••••••••••••••••••",
                                    "••••••••••••••••••••",
                                    "•••••••••••••••••••••••",
                                    "•••••••••••••",
                                    "•••••••••••••••••••••",
                                    "•••••••••••••••••••••••",
                                    "••••••••",
                                    "••••••••••••••••••••",
                                    "•••••••••••••••••",
                                    "•••••••••••••••••",
                                    "•••••••••••",
                                    "••••••••••",
                                    "••••••••••••••",
                                    "••••••••••••",
                                    "•••••••••••",
                                    "••••••••••",
                                    "••••••••••",
                                    "••••••••••••",
                                    "••••••••••••••••",
                                    "•••••••••••••",
                                    "•••••••••",
                                    "•••••••••••",
                                    "•••••••",
                                    "•••••••",
                                    "••••••••••",
                                    "••••••",
                                    "••••••••",
                                    "••••••••••",
                                    "••••••••••••••••",
                                    "••••••••••••",
                                    "•••••••",
                                    "•••••••••••••••",
                                    "••••••••••",
                                    "••••••••••••••••••",
                                    "•••••••",
                                    "••••••••",
                                    "•••••••",
                                    "•••••••••••••",
                                    "•••••••••••",
                                    "••••••••••",
                                    "••••••••••••••••",
                                    "•••••••••••",
                                    "•••••••••••",
                                    "•••••••••••••••",
                                    "•••••••••••",
                                    "•••••••",
                                    "•••••••••••••",
                                    "•••••••••••••",
                                    "•••••••••••••",
                                    "•••••••••••••••••",
                                    "••••••••",
                                    "••••••••••••",
                                    "••••••••••••",
                                    "••••••••",
                                    "••••••••••••••",
                                    "•••••••••••",
                                    "•••••••••••••",
                                    "••••••••••••••••",
                                    "•••••••••••",
                                    "•••••••",
                                    "•••••••••",
                                    "••••••••••••",
                                    "•••••••••••••••",
                                    "•••••••••••••••",
                                    "•••••••••",
                                    "•••••••••••",
                                    "••••••••",
                                    "•••••••••••",
                                    "••••••••••••••",
                                    "•••••••••••",
                                    "••••••••••••••",
                                    "••••••••••••••••",
                                    "••••••••••••••••",
                                    "•••••••••••••••",
                                    "••••••••",
                                    "•••••••••••",
                                    "•••••••••••",
                                    "••••••••••••••••",
                                    "•••",
                                    "••••••••",
                                    "•••••••••",
                                ],
                                "ip": "••••••••••••••",
                                "malware_path": "•••••••••••••",
                            },
                            {
                                "date_uploaded": "2021-05-06T05:58:56.299Z",
                                "stealer_family": "RedLine",
                                "computer_name": "jskho",
                                "operating_system": "Windows 10 Home x64",
                                "antiviruses": "Norton Security",
                                "employee_session_cookies": "null",
                                "date_compromised": "2021-05-06T01:31:09.000Z",
                                "credentials": [
                                    {
                                        "type": "client",
                                        "url": "•••••••••••••••••",
                                        "domain": "disney.com",
                                        "username": "•••••••@gmail.com",
                                        "password": "••••••••",
                                    }
                                ],
                                "stealer": "•••••••••••••••",
                                "employeeAt": [],
                                "clientAt": [
                                    "••••••••••••••",
                                    "•••••••••••••••••••",
                                    "•••••••••••",
                                    "•",
                                    "•",
                                    "••••",
                                    "••••••••••••••••",
                                    "••••••••••••••••••••",
                                    "•••••••••••••••••••••",
                                    "••••••••••••",
                                    "••••••••••",
                                    "•••••••••••••••",
                                    "•••••••••",
                                    "•••••",
                                    "••••••••••••",
                                    "•••••••••••••",
                                    "••••••••••••••••••••••",
                                    "•••••••••••••••••",
                                    "•••••••••••••",
                                    "•••••••••••",
                                    "••••••••••••",
                                    "••••••••",
                                    "•••••••••",
                                    "••••••••••••••",
                                    "••••••",
                                    "••••••••••••",
                                    "••••••••••••••••",
                                    "••••••••••••••",
                                    "•••••••••••••••",
                                    "•••••••••••••",
                                    "•••••••••••",
                                    "•••••••••••••••••••",
                                    "•••••••••••••••••••",
                                    "••••••••",
                                    "••••••••••••••••••",
                                    "•••••••••",
                                    "•••••••••",
                                    "•••••••••••••••••••••",
                                    "•••••••••••••••••••••",
                                    "•••••••••••••••••••••",
                                    "••••••••••••••••",
                                    "•••••••••••••••••••",
                                    "•••••••••••••••••••••",
                                    "••••••••••",
                                    "•••••••••••••••••••••",
                                    "••••••••••••••••••••••••••",
                                    "•••••••••••••",
                                    "•••••••",
                                    "••••••••••••••",
                                    "••••••••••",
                                    "••••••••••",
                                    "•••••••••••",
                                    "•••••••••",
                                    "••••••••",
                                    "••••••",
                                    "••••••",
                                    "•••••••••••",
                                    "•••••••••••••••••••",
                                    "•••••••••••••••",
                                    "••••••••••",
                                    "•••••••••••••••••",
                                    "••••••••••••",
                                    "••••••••••••••••••",
                                    "•••••••••",
                                    "••••••••••••",
                                    "••••••••••••••••••",
                                    "•••••••••",
                                    "••••••",
                                    "••••••••••",
                                    "••••••••••••••••••",
                                    "••••••••••",
                                    "•••••••••••",
                                    "••••••••••••",
                                    "••••••••••••",
                                    "•••••••••••••",
                                    "••••••••••••••••••••",
                                    "•••••",
                                    "••••••••",
                                    "•••••••••••",
                                    "••••••••••••••",
                                    "•••••••••••••••",
                                    "•••••••••••••",
                                    "•••••••••••••",
                                    "••••••••••",
                                    "••••••••••",
                                    "••••••••••••••••",
                                    "••••••••",
                                    "•••••••••",
                                    "••••••••••",
                                    "•••••••••••••",
                                    "••••••••••",
                                    "•••••••••••",
                                    "••••••••••••••",
                                    "••••••••",
                                    "•••••••••••••••••",
                                    "••••••••••••••••••",
                                    "•••••••••",
                                    "•••••••••••••",
                                    "••••••••••••••••••",
                                    "•••••••••••••••",
                                    "•••••••••",
                                    "••••••••••••••",
                                    "•••••••••••••••••",
                                    "••••••••••••••••",
                                    "••••••••••••••••",
                                    "•••••••••••",
                                    "•••••••••••••••••••••••••",
                                    "•••••••••••",
                                    "••••••••••••",
                                    "••••••••••••••",
                                    "•••••••••",
                                    "••••••••",
                                    "••••••••••••••••••••",
                                    "••••••••••••••••",
                                    "•••••••••••••",
                                    "•••••••••••••••••••••",
                                    "••••••••••••••••",
                                    "•••••••••••••••",
                                    "•••••••••••••",
                                    "••••••••••",
                                    "•••••••••••••",
                                    "•••••••••••••",
                                    "••••••••••••",
                                    "••••••••••••••••",
                                    "••••••••••••",
                                    "•••••••••",
                                    "••••••••••••",
                                    "••••••••••••",
                                    "•••••••••••••••••",
                                    "•••••••••••••",
                                    "•••••••••••••",
                                    "••••••••",
                                    "•••••••••••••••••••••",
                                    "••••••••••••",
                                    "••••••••••••",
                                    "••••••••••••",
                                    "••••••••••••••••••••••",
                                    "•••••••••",
                                    "•••••••••••••••••••••",
                                    "••••••••••••••",
                                    "•••••••••••••••••••",
                                    "•••••••••••••",
                                    "•••••••••••",
                                    "••••••••••",
                                    "•••••••••••",
                                    "•••••••••••",
                                    "•••••••••••••••••••",
                                    "••••••••••••••••••",
                                    "••••••••••••••••",
                                    "•••••••••",
                                    "••••••••••••••••••",
                                    "••••••••••••••••",
                                    "•••••••••••••",
                                    "••••••••••••••••",
                                    "••••••••••••••••••••",
                                    "••••••••••••",
                                    "•••••••••••",
                                    "••••••••••",
                                    "•••••••••••••••••",
                                    "•••••••••••••••••",
                                    "•••••••••••••",
                                    "•••••••••••••••",
                                    "••••••••",
                                    "••••••••••",
                                    "•••••••••••••••••••••",
                                    "•••••••••",
                                    "•••••••••••",
                                    "•••••••••••••••",
                                    "•••••••••••",
                                    "•••••••",
                                    "••••••••",
                                    "••••••••",
                                    "•••••••••",
                                    "•••••••••••••••",
                                    "••••••••••••••••",
                                    "••••••••••••••••••",
                                    "•••••••••",
                                    "••••••••••••••••",
                                    "•••••••",
                                    "•••",
                                ],
                                "ip": "•••••••••••••",
                                "malware_path": "••••••",
                            },
                            {
                                "date_uploaded": "2021-04-02T11:46:34.357Z",
                                "stealer_family": "RedLine",
                                "computer_name": "samih",
                                "operating_system": "Windows 10 Home x64",
                                "antiviruses": "Windows Defender",
                                "employee_session_cookies": "null",
                                "date_compromised": "2021-03-31T18:23:31.000Z",
                                "credentials": [
                                    {
                                        "type": "client",
                                        "url": "",
                                        "domain": "disney.com",
                                        "username": "••••••••",
                                        "password": "••••••••••",
                                    },
                                    {
                                        "type": "client",
                                        "url": "•••••••••••••••••",
                                        "domain": "disney.com",
                                        "username": "••••••••",
                                        "password": "••••••••••",
                                    },
                                ],
                                "stealer": "••••••••••••••••••••",
                                "employeeAt": [],
                                "clientAt": [
                                    "•",
                                    "•",
                                    "••••",
                                    "•••••••••••••••••••",
                                    "••••••••••••••••",
                                    "•••••••••••••••••",
                                    "••••••••••",
                                    "•••••••••••",
                                    "••••••",
                                    "••••••••",
                                    "••••••••••••",
                                    "••••••••••",
                                    "•••••••••",
                                    "•••••••••••••••••••",
                                    "••••••••••••••••••",
                                    "••••••••••••",
                                    "••••••••••",
                                    "••••••••••",
                                    "••••••••••",
                                    "•••••••••••••••••",
                                    "••••••••••",
                                    "•••••••••••••",
                                    "••••••••",
                                    "••••••••••••••••••••••••••••",
                                    "••••••••••••••••",
                                    "•••••••••",
                                    "•••",
                                ],
                                "ip": "••••••••••••••",
                                "malware_path": "•••••",
                            },
                        ],
                        200,
                    ),
                ),
            )
        ]
        return super()._monkeypatch(patches=patches)
